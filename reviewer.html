<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviewer | ÂÆ°Ê†∏Âëò</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; min-height: 100vh; background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); color: #fff; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        .lang-switch { position: fixed; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 100; }
        .lang-switch button { padding: 8px 12px; border: 2px solid #ffd700; background: rgba(255, 215, 0, 0.2); color: #ffd700; border-radius: 8px; cursor: pointer; }
        .lang-switch button.active { background: #ffd700; color: #1a1a2e; }
        
        .lang-screen { padding-top: 80px; text-align: center; }
        .lang-screen h1 { font-size: 2em; color: #ffd700; margin-bottom: 10px; }
        .lang-screen h2 { font-size: 1.5em; color: #87CEEB; margin-bottom: 40px; }
        .lang-selector { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .lang-btn { width: 250px; padding: 20px; font-size: 18px; border: 2px solid #ffd700; background: rgba(255, 215, 0, 0.1); color: #ffd700; border-radius: 10px; cursor: pointer; }
        .lang-btn:hover { background: #ffd700; color: #1a1a2e; }
        
        .header { text-align: center; padding: 20px 0; border-bottom: 2px solid #ffd700; margin-bottom: 25px; }
        .header h1 { color: #ffd700; font-size: 1.6em; margin-bottom: 10px; }
        .header p { color: #87CEEB; }
        
        .stats-bar { display: flex; justify-content: center; gap: 30px; margin-bottom: 25px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; }
        .stat-item { text-align: center; }
        .stat-item .number { font-size: 2em; font-weight: bold; color: #FF9800; }
        .stat-item .label { color: #87CEEB; font-size: 0.9em; }
        
        .search-box { margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 14px; font-size: 16px; border: 2px solid #ffd700; border-radius: 10px; background: rgba(0, 0, 0, 0.3); color: #fff; }
        .search-box input:focus { outline: none; border-color: #FF9800; }
        .search-box input::placeholder { color: rgba(255, 255, 255, 0.5); }
        
        .reg-list { display: flex; flex-direction: column; gap: 15px; }
        
        .reg-card { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 193, 7, 0.5); border-radius: 15px; padding: 20px; }
        .reg-card.verified { border-color: rgba(76, 175, 80, 0.5); }
        .reg-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .reg-name { font-size: 1.3em; font-weight: bold; color: #fff; }
        .reg-role { padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }
        .reg-role.visitor { background: rgba(33, 150, 243, 0.3); color: #64B5F6; }
        .reg-role.staff { background: rgba(156, 39, 176, 0.3); color: #CE93D8; }
        
        .reg-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .reg-detail { background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 8px; }
        .reg-detail .label { color: #87CEEB; font-size: 0.8em; margin-bottom: 3px; }
        .reg-detail .value { color: #fff; font-weight: bold; }
        .reg-detail .value.lottery { color: #ffd700; font-size: 1.3em; }
        
        .reg-actions { display: flex; gap: 10px; }
        .approve-btn { flex: 1; padding: 14px; font-size: 1.1em; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .approve-btn.pending { background: linear-gradient(135deg, #4CAF50, #388E3C); color: #fff; }
        .approve-btn.pending:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
        .approve-btn.done { background: rgba(76, 175, 80, 0.3); color: #4CAF50; cursor: default; }
        
        .empty-state { text-align: center; padding: 50px 20px; color: #87CEEB; }
        .empty-state .icon { font-size: 4em; margin-bottom: 15px; }
        .empty-state h3 { margin-bottom: 10px; color: #ffd700; }
        
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255, 215, 0, 0.3); border-top-color: #ffd700; border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .refresh-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #FF9800, #F57C00); border: none; color: #fff; font-size: 1.5em; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4); }
        .refresh-btn:hover { transform: scale(1.1); }
        
        .hidden { display: none !important; }
        
        @media (max-width: 480px) {
            .reg-details { grid-template-columns: 1fr; }
            .stats-bar { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="lang-switch">
        <button id="switchIt">üáÆüáπ IT</button>
        <button id="switchZh">üá®üá≥ ‰∏≠Êñá</button>
    </div>
    
    <button class="refresh-btn" id="btnRefresh">üîÑ</button>
    
    <div class="container">
        <!-- LANGUAGE SELECTION -->
        <div class="lang-screen" id="langScreen">
            <h1>üèÆ Festa delle Lanterne 2026</h1>
            <h2>Reviewer | ÂÆ°Ê†∏Âëò</h2>
            <div class="lang-selector">
                <button class="lang-btn" id="btnLangIt">üáÆüáπ Italiano</button>
                <button class="lang-btn" id="btnLangZh">üá®üá≥ ‰∏≠Êñá</button>
            </div>
        </div>
        
        <!-- MAIN SCREEN -->
        <div id="mainScreen" class="hidden">
            <div class="header">
                <h1 id="headerTitle">üìã Verifica Registrazioni</h1>
                <p id="headerSub">Approva le registrazioni in attesa</p>
            </div>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="number" id="statPending">0</div>
                    <div class="label" id="lblPending">Da Verificare</div>
                </div>
                <div class="stat-item">
                    <div class="number" id="statVerified" style="color:#4CAF50;">0</div>
                    <div class="label" id="lblVerified">Verificati</div>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Cerca nome o email...">
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">Caricamento...</p>
            </div>
            
            <div class="reg-list" id="regList"></div>
        </div>
    </div>

    <script>
    (function() {
        var SUPABASE_URL = 'https://mfwgfgjneeymavxgbwde.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1md2dmZ2puZWV5bWF2eGdid2RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MTMzNzgsImV4cCI6MjA4Mzk4OTM3OH0.11Ww-TwArHnrM6Lw7q_ZbJu5tFLugsAq9jT6H6p42WE';
        var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        var lang = 'it', allData = [];
        
        var T = {
            it: {
                headerTitle: 'üìã Verifica Registrazioni',
                headerSub: 'Approva le registrazioni in attesa',
                lblPending: 'Da Verificare',
                lblVerified: 'Verificati',
                searchPh: 'Cerca nome o email...',
                loadingText: 'Caricamento...',
                visitor: 'Visitatore',
                staff: 'Staff',
                lblId: 'ID',
                lblLottery: 'Lotteria',
                lblEmail: 'Email',
                lblPhone: 'Telefono',
                lblTime: 'Orario',
                btnApprove: '‚úì APPROVA',
                btnApproved: '‚úì Approvato',
                emptyTitle: 'Nessuna registrazione',
                emptyMsg: 'Non ci sono registrazioni da verificare',
                allDoneTitle: '‚úÖ Tutto fatto!',
                allDoneMsg: 'Tutte le registrazioni sono state verificate'
            },
            zh: {
                headerTitle: 'üìã ÂÆ°Ê†∏Ê≥®ÂÜå',
                headerSub: 'ÂÆ°Ê†∏ÂæÖÂ§ÑÁêÜÁöÑÊ≥®ÂÜå',
                lblPending: 'ÂæÖÂÆ°Ê†∏',
                lblVerified: 'Â∑≤ÂÆ°Ê†∏',
                searchPh: 'ÊêúÁ¥¢ÂßìÂêçÊàñÈÇÆÁÆ±...',
                loadingText: 'Âä†ËΩΩ‰∏≠...',
                visitor: 'ËÆøÂÆ¢',
                staff: 'Â∑•‰Ωú‰∫∫Âëò',
                lblId: 'ID',
                lblLottery: 'ÊäΩÂ•ñÂè∑',
                lblEmail: 'ÈÇÆÁÆ±',
                lblPhone: 'ÁîµËØù',
                lblTime: 'Êó∂Èó¥',
                btnApprove: '‚úì ÈÄöËøá',
                btnApproved: '‚úì Â∑≤ÈÄöËøá',
                emptyTitle: 'Ê≤°ÊúâÊ≥®ÂÜå',
                emptyMsg: 'Ê≤°ÊúâÈúÄË¶ÅÂÆ°Ê†∏ÁöÑÊ≥®ÂÜå',
                allDoneTitle: '‚úÖ ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ',
                allDoneMsg: 'ÊâÄÊúâÊ≥®ÂÜåÈÉΩÂ∑≤ÂÆ°Ê†∏'
            }
        };
        
        var $ = function(id) { return document.getElementById(id); };
        
        function updateUI() {
            var t = T[lang];
            $('headerTitle').textContent = t.headerTitle;
            $('headerSub').textContent = t.headerSub;
            $('lblPending').textContent = t.lblPending;
            $('lblVerified').textContent = t.lblVerified;
            $('searchInput').placeholder = t.searchPh;
            $('loadingText').textContent = t.loadingText;
            $('switchIt').classList.toggle('active', lang === 'it');
            $('switchZh').classList.toggle('active', lang === 'zh');
        }
        
        function selectLanguage(l) {
            lang = l;
            $('langScreen').classList.add('hidden');
            $('mainScreen').classList.remove('hidden');
            updateUI();
            loadData();
            
            // Real-time updates
            supabase.channel('reviewer').on('postgres_changes', { event: '*', schema: 'public', table: 'registrations' }, function() { loadData(); }).subscribe();
        }
        
        function switchLanguage(l) {
            lang = l;
            updateUI();
            renderList();
        }
        
        async function loadData() {
            $('loading').style.display = 'block';
            $('regList').innerHTML = '';
            
            try {
                var { data, error } = await supabase.from('registrations').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                allData = data || [];
                updateStats();
                renderList();
            } catch (e) {
                console.error(e);
            }
            
            $('loading').style.display = 'none';
        }
        
        function updateStats() {
            var pending = allData.filter(function(r) { return r.verified !== true; }).length;
            var verified = allData.filter(function(r) { return r.verified === true; }).length;
            $('statPending').textContent = pending;
            $('statVerified').textContent = verified;
        }
        
        function renderList() {
            var t = T[lang];
            var search = $('searchInput').value.toLowerCase();
            
            // Filter: show pending first, then verified
            var filtered = allData.filter(function(r) {
                if (search) {
                    var matchName = r.name && r.name.toLowerCase().indexOf(search) !== -1;
                    var matchEmail = r.email && r.email.toLowerCase().indexOf(search) !== -1;
                    var matchPhone = r.phone && r.phone.indexOf(search) !== -1;
                    if (!matchName && !matchEmail && !matchPhone) return false;
                }
                return true;
            });
            
            // Sort: pending first
            filtered.sort(function(a, b) {
                if (a.verified === true && b.verified !== true) return 1;
                if (a.verified !== true && b.verified === true) return -1;
                return 0;
            });
            
            if (filtered.length === 0) {
                $('regList').innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><h3>' + t.emptyTitle + '</h3><p>' + t.emptyMsg + '</p></div>';
                return;
            }
            
            var pendingCount = filtered.filter(function(r) { return r.verified !== true; }).length;
            if (pendingCount === 0 && filtered.length > 0) {
                $('regList').innerHTML = '<div class="empty-state"><div class="icon">üéâ</div><h3>' + t.allDoneTitle + '</h3><p>' + t.allDoneMsg + '</p></div>' + renderCards(filtered);
                return;
            }
            
            $('regList').innerHTML = renderCards(filtered);
        }
        
        function renderCards(list) {
            var t = T[lang];
            return list.map(function(r) {
                var isVerified = r.verified === true;
                var roleClass = r.role || 'visitor';
                var roleText = t[r.role] || t.visitor;
                var btnClass = isVerified ? 'done' : 'pending';
                var btnText = isVerified ? t.btnApproved : t.btnApprove;
                var btnClick = isVerified ? '' : 'onclick="approveReg(\'' + r.id + '\')"';
                
                return '<div class="reg-card ' + (isVerified ? 'verified' : '') + '">' +
                    '<div class="reg-card-header">' +
                        '<span class="reg-name">' + r.name + '</span>' +
                        '<span class="reg-role ' + roleClass + '">' + roleText + '</span>' +
                    '</div>' +
                    '<div class="reg-details">' +
                        '<div class="reg-detail"><div class="label">' + t.lblLottery + '</div><div class="value lottery">' + r.lottery_number + '</div></div>' +
                        '<div class="reg-detail"><div class="label">' + t.lblTime + '</div><div class="value">' + (r.entry_time || '--') + '</div></div>' +
                        '<div class="reg-detail"><div class="label">' + t.lblEmail + '</div><div class="value">' + (r.email || '-') + '</div></div>' +
                        '<div class="reg-detail"><div class="label">' + t.lblPhone + '</div><div class="value">' + (r.phone || '-') + '</div></div>' +
                    '</div>' +
                    '<div class="reg-actions">' +
                        '<button class="approve-btn ' + btnClass + '" ' + btnClick + '>' + btnText + '</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }
        
        window.approveReg = async function(id) {
            try {
                var { error } = await supabase.from('registrations').update({ verified: true }).eq('id', id);
                if (error) throw error;
                
                // Update local data
                for (var i = 0; i < allData.length; i++) {
                    if (allData[i].id === id) {
                        allData[i].verified = true;
                        break;
                    }
                }
                updateStats();
                renderList();
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        };
        
        // Events
        $('btnLangIt').addEventListener('click', function() { selectLanguage('it'); });
        $('btnLangZh').addEventListener('click', function() { selectLanguage('zh'); });
        $('switchIt').addEventListener('click', function() { switchLanguage('it'); });
        $('switchZh').addEventListener('click', function() { switchLanguage('zh'); });
        $('btnRefresh').addEventListener('click', loadData);
        $('searchInput').addEventListener('input', renderList);
    })();
    </script>
</body>
</html>
